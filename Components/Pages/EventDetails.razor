@page "/event/{id:int}"
@using EventEase.Models
@using EventEase.Services
@inject EventService EventService
@inject UserSessionService UserSessionService

<PageTitle>@GetPageTitle() - EventEase</PageTitle>

<div class="event-details-page">
    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading event details...</p>
        </div>
    }
    else if (CurrentEvent != null)
    {
        <div class="event-header">
            <h1>@CurrentEvent.Name</h1>
            <div class="event-meta">
                <span class="badge bg-primary">@GetFormattedDate()</span>
                <span class="badge bg-secondary">@GetLocation()</span>
                @if (IsUserRegistered)
                {
                    <span class="badge bg-success">âœ“ Registered</span>
                }
            </div>
        </div>

        <div class="event-content">
            <div class="card">
                <div class="card-body">
                    <h3>Event Details</h3>
                    <hr />
                    <div class="detail-row">
                        <strong>Event Name:</strong>
                        <input type="text" 
                               class="form-control @GetValidationClass(EventName)" 
                               @bind="EventName" 
                               @bind:event="oninput"
                               maxlength="100" 
                               placeholder="Enter event name" />
                        @if (string.IsNullOrWhiteSpace(EventName))
                        {
                            <small class="text-danger">Event name is required</small>
                        }
                    </div>
                    <div class="detail-row">
                        <strong>Date:</strong>
                        <input type="date" 
                               class="form-control @GetValidationClass(EventDate.ToString())" 
                               @bind="EventDate" 
                               @bind:event="oninput"
                               min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        @if (EventDate < DateTime.Today)
                        {
                            <small class="text-warning">Event date is in the past</small>
                        }
                    </div>
                    <div class="detail-row">
                        <strong>Location:</strong>
                        <input type="text" 
                               class="form-control @GetValidationClass(EventLocation)" 
                               @bind="EventLocation" 
                               @bind:event="oninput"
                               maxlength="200" 
                               placeholder="Enter event location" />
                        @if (string.IsNullOrWhiteSpace(EventLocation))
                        {
                            <small class="text-danger">Event location is required</small>
                        }
                    </div>
                    <div class="detail-row">
                        <strong>Description:</strong>
                        <textarea class="form-control" 
                                  rows="4" 
                                  @bind="EventDescription" 
                                  @bind:event="oninput"
                                  maxlength="500" 
                                  placeholder="Enter event description"></textarea>
                        <small class="text-muted">@GetDescriptionLength() / 500 characters</small>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                @if (IsUserRegistered)
                {
                    <div class="alert alert-success">
                        <strong>You're registered for this event!</strong> See your registrations in <a href="/my-events">My Events</a>.
                    </div>
                    <a href="/my-events" class="btn btn-primary btn-lg">View My Events</a>
                }
                else
                {
                    <a href="/register/@Id" class="btn btn-success btn-lg">Register for Event</a>
                }
                <a href="/events" class="btn btn-outline-secondary btn-lg">Back to Events</a>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <h4>Event Not Found</h4>
            <p>The event you're looking for doesn't exist or has been removed.</p>
            <a href="/events" class="btn btn-primary">Browse Events</a>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Event? CurrentEvent { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool IsUserRegistered { get; set; } = false;

    // Two-way binding properties with validation
    private string EventName { get; set; } = string.Empty;
    private DateTime EventDate { get; set; } = DateTime.Today;
    private string EventLocation { get; set; } = string.Empty;
    private string EventDescription { get; set; } = string.Empty;

    protected override void OnInitialized()
    {
        try
        {
            CurrentEvent = EventService.GetEventById(Id);
            
            if (CurrentEvent != null)
            {
                // Initialize binding properties
                EventName = CurrentEvent.Name ?? string.Empty;
                EventDate = CurrentEvent.Date;
                EventLocation = CurrentEvent.Location ?? string.Empty;
                EventDescription = CurrentEvent.Description ?? string.Empty;

                // Check if user is registered
                IsUserRegistered = UserSessionService.IsEventRegistered(Id);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading event: {ex.Message}");
            CurrentEvent = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetPageTitle()
    {
        return CurrentEvent?.Name ?? "Event Details";
    }

    private string GetFormattedDate()
    {
        try
        {
            return EventDate.ToString("MMMM dd, yyyy");
        }
        catch
        {
            return "Invalid Date";
        }
    }

    private string GetLocation()
    {
        return !string.IsNullOrWhiteSpace(EventLocation) ? EventLocation : "Location TBD";
    }

    private string GetValidationClass(string? value)
    {
        return string.IsNullOrWhiteSpace(value) ? "is-invalid" : "is-valid";
    }

    private int GetDescriptionLength()
    {
        return EventDescription?.Length ?? 0;
    }
}
